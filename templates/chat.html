<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MoreAI Chat</title>
    <link href="{{ url_for('static', filename='styles/style.css')}}" rel="stylesheet" />
    <style>
        /* Стили для иконки микрофона на кнопке */
        #mic-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 12px;
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            color: var(--primary-color);
        }
        #mic-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }
        #mic-button:hover svg {
            fill: #1f6b6b;
        }
        /* Стили для кнопки отправки с иконкой */
        .chat-form button[type="submit"] {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 16px;
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            color: var(--primary-color);
        }
        .chat-form button[type="submit"] svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
            transition: fill 0.2s ease;
        }
        .chat-form button[type="submit"]:hover svg {
            fill: #1f6b6b;
        }
        
        .message-timestamp {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    {% include 'nav.html' %}
    <div class="container">
        <div class="title">
            <h1>MoreAI Chat</h1>
            <h2>Your Personal AI Companion</h2>
        </div>
        <div class="chat-wrapper">
            <div class="chat-container" id="chatContainer">
                {% for message in history %}
                    {% if message.type == 'user' %}
                        <div class="message user-message">
                            <div class="message-content">{{ message.message }}</div>
                            <div class="message-timestamp">{{ message.timestamp }}</div>
                        </div>
                    {% elif message.type == 'assistant' %}
                        <div class="message bot-message">
                            <div class="message-content">{{ message.message }}</div>
                            <div class="message-timestamp">{{ message.timestamp }}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <form autocomplete="off" class="chat-form">
                <div class="input-container">
                    <input type="text" name="usertext" id="usertext" placeholder="Enter message..." autofocus />
                    <button type="submit" aria-label="Send message" title="Send message">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                    <button type="button" id="mic-button" aria-label="Voice input" title="Voice input">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v2h-2v-2z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let voiceRecognitionActive = false;

        document.querySelector('.chat-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const usertextInput = document.getElementById('usertext');
            const usertext = usertextInput.value.trim();
            if (!usertext) return;

            const chatContainer = document.getElementById('chatContainer');

            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message user-message';
            userMsgDiv.innerHTML = `<div class="message-content">${usertext}</div>`;
            chatContainer.appendChild(userMsgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            usertextInput.value = '';
            usertextInput.focus();

            try {
                const params = new URLSearchParams({ usertext });
                const response = await fetch('/chat?' + params.toString(), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error('Network error');

                const data = await response.json();
                const history = data.history;

                if (history.length === 0) return;

                // Find the last assistant message
                const lastBotMessage = history[history.length - 1];
                if (lastBotMessage.type === 'assistant') {
                    const botMsgDiv = document.createElement('div');
                    botMsgDiv.className = 'message bot-message';
                    botMsgDiv.innerHTML = `<div class="message-content">${lastBotMessage.message}</div>`;
                    chatContainer.appendChild(botMsgDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

            } catch (error) {
                alert('Ошибка при отправке сообщения: ' + error.message);
            }
        });

        document.getElementById('mic-button').addEventListener('click', function () {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Ваш браузер не поддерживает голосовой ввод.');
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceRecognitionActive = true;

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('usertext');
                input.value = transcript;
                input.form.dispatchEvent(new Event('submit', { cancelable: true }));
            };
            recognition.onerror = function (event) {
                alert('Ошибка распознавания голоса: ' + event.error);
            };
            recognition.onend = function () {
                voiceRecognitionActive = false;
            };
            recognition.start();
        });
    </script>
</body>
</html>