<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>more - first AI psychologist in Azerbaijan</title>
    <link href="{{ url_for('static', filename='styles/style.css')}}" rel="stylesheet" />
</head>
<body>
    <div class="header">
        <a class="active" href="chat">more</a>
        <a href="journal">Journal</a>
    </div>
    <div class="container">
        <div class="title">
            <h1>more</h1>
            <h2>first AI psychologist in Azerbaijan</h2>
        </div>
        <div class="chat-wrapper">
            <div class="chat-container" id="chatContainer">
                {% for message in history %}
                    <div class="message user-message">
                        <div class="message-content">{{ message[0] }}</div>
                    </div>
                    <div class="message bot-message">
                        <div class="message-content">{{ message[1] }}</div>
                    </div>
                {% endfor %}
            </div>
            <form autocomplete="off" class="chat-form">
                <div class="input-container">
                    <input type="text" name="usertext" id="usertext" placeholder="Enter message..." autofocus />
                    <button type="submit">Send</button>
                    <button type="button" id="mic-button">üé§</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let voiceRecognitionActive = false;

        document.querySelector('.chat-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const usertextInput = document.getElementById('usertext');
            const usertext = usertextInput.value.trim();
            if (!usertext) return;

            const chatContainer = document.getElementById('chatContainer');

            // –°—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message user-message';
            userMsgDiv.innerHTML = `<div class="message-content">${usertext}</div>`;
            chatContainer.appendChild(userMsgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            usertextInput.value = '';
            usertextInput.focus();

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const params = new URLSearchParams({ usertext });
                const response = await fetch('/chat?' + params.toString(), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error('Network error');

                const data = await response.json();
                const history = data.history;

                if (history.length === 0) return;

                // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
                const lastBotMessage = history[history.length - 1][1];

                const botMsgDiv = document.createElement('div');
                botMsgDiv.className = 'message bot-message';
                botMsgDiv.innerHTML = `<div class="message-content">${lastBotMessage}</div>`;
                chatContainer.appendChild(botMsgDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            }
        });

        // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
        document.getElementById('mic-button').addEventListener('click', function () {
            if (!('webkitSpeechRecognition' in window)) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥.');
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceRecognitionActive = true;

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('usertext');
                input.value = transcript;
                input.form.dispatchEvent(new Event('submit', { cancelable: true }));
            };
            recognition.onerror = function (event) {
                alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞: ' + event.error);
            };
            recognition.onend = function () {
                voiceRecognitionActive = false;
            };
            recognition.start();
        });
    </script>
</body>
</html>